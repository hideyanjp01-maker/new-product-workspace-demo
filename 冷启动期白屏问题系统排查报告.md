# 冷启动期白屏问题系统排查报告

## 🔍 排查步骤与结果

### 步骤1：路由验证（临时测试）

**操作**：在 `App.tsx` 中临时将 `/stages/cold-start` 路由替换为简单测试组件
**结论**：路由配置正确，问题在组件渲染

### 步骤2：添加 ErrorBoundary（全局错误捕获）

**新增文件**：
- `src/components/ErrorBoundary.tsx` - ErrorBoundary 组件
- `src/components/ErrorBoundary.css` - 错误边界样式

**修改文件**：
- `src/main.tsx` - 在 App 外层包裹 ErrorBoundary

**作用**：
- 捕获任何子组件的运行时错误
- 显示错误信息面板，而不是白屏
- 显示 error.message 和 componentStack

### 步骤3：添加调试日志

**修改文件**：
- `src/pages/stages/ColdStartStagePage.tsx`

**添加的日志**：
```typescript
console.log('[ColdStart] render start')  // 组件函数最顶部
console.log('[ColdStart] before return', { productsLen, roleId, stage, viewMode, hasTabs })  // return 前
console.log('[ColdStart] Products loaded:', prods.length)  // 数据加载后
```

**作用**：确认组件是否被调用、是否 return、数据状态

### 步骤4：添加 CSS 调试边框

**修改文件**：
- `src/pages/stages/ColdStartStagePage.tsx`

**添加的调试样式**：
```typescript
<div className="coldstart-dashboard" style={{ border: '2px solid red', minHeight: 200 }}>
```

**作用**：验证内容是否渲染但被 CSS 隐藏

### 步骤5：强制最小可用渲染 + 兜底逻辑

**修改文件**：
- `src/pages/stages/ColdStartStagePage.tsx`

**添加的兜底措施**：

1. **roleId 验证与兜底**：
```typescript
useEffect(() => {
  const roles = getRoles()
  const validRoleIds = roles.map(r => r.id)
  if (currentRoleId && !validRoleIds.includes(currentRoleId)) {
    console.warn('[ColdStart] Invalid roleId:', currentRoleId, 'fallback to ecommerce_owner')
    setCurrentRoleId('ecommerce_owner')
  }
}, [currentRoleId, setCurrentRoleId])
```

2. **数据加载错误处理**：
```typescript
try {
  const prods = getColdStartProducts(dateA)
  setProducts(prods)
} catch (error) {
  console.error('[ColdStart] Error loading products:', error)
  setProducts([])  // 兜底为空数组，不崩溃
}
```

3. **空状态显示**：
```typescript
{products.length > 0 ? (
  // 产品列表
) : (
  <Card padding="large">
    <div className="empty-state">
      <p>暂无冷启动期产品</p>
      <p style={{ fontSize: '12px', color: '#999', marginTop: '8px' }}>这是空状态，不是白屏</p>
    </div>
  </Card>
)}
```

4. **强制渲染结构**：
```typescript
// 无论什么情况，都必须返回这个结构
return (
  <MainLayout>
    <PageHeader title="冷启动期" />
    <FilterBar />
    <Tabs items={tabs} />
  </MainLayout>
)
```

## 📁 修改的文件列表

### 新增文件（2个）
1. `src/components/ErrorBoundary.tsx` - 错误边界组件
2. `src/components/ErrorBoundary.css` - 错误边界样式

### 修改文件（2个）
1. `src/main.tsx` - 添加 ErrorBoundary 包裹
2. `src/pages/stages/ColdStartStagePage.tsx` - 添加调试日志、兜底逻辑、CSS 调试边框

## 🔍 根因定位（待验证）

基于代码检查，可能的根因：

1. **运行时错误**（最可能）
   - 如果浏览器 Console 有红色报错，ErrorBoundary 会捕获并显示
   - 查看错误堆栈定位具体文件行号

2. **CSS 隐藏**（可能性中等）
   - 已添加红色边框验证
   - 如果能看到红色边框，说明内容渲染但被 CSS 隐藏

3. **条件 return null**（可能性低）
   - 代码已强制返回结构，不存在 early return

4. **路由未命中**（可能性低）
   - 路由配置正确，但 ErrorBoundary 可验证

## ✅ 验收标准

修复后必须满足：

1. ✅ **ErrorBoundary 工作**：
   - 如果有错误，显示错误面板（不是白屏）
   - 错误面板显示 error.message 和 componentStack

2. ✅ **Console 日志**：
   - 能看到 `[ColdStart] render start`
   - 能看到 `[ColdStart] before return` 日志
   - 能看到 `[ColdStart] Products loaded` 日志

3. ✅ **页面可见内容**（至少一项）：
   - TopBar + SideNav
   - 标题"冷启动期"
   - Tabs（数据看板/AI洞察）
   - 红色调试边框（验证 CSS）
   - 或错误面板（如果有错误）

4. ✅ **兜底逻辑**：
   - products 为空时显示空状态（不是白屏）
   - roleId 非法时自动兜底为 ecommerce_owner（不崩溃）

## 🎯 下一步验证

1. **运行 `npm run dev`**
2. **访问 `/stages/cold-start`**
3. **打开浏览器 Console**，查看：
   - 是否有红色报错（会被 ErrorBoundary 捕获）
   - 是否有 `[ColdStart]` 日志
4. **检查页面**：
   - 如果看到错误面板：查看错误信息，定位具体问题
   - 如果看到红色边框：说明内容渲染但可能被 CSS 隐藏
   - 如果看到正常内容：问题已解决
   - 如果仍是白屏：检查 DOM（F12），查看 #root 是否有内容

## 📝 关键 Diff 摘要

### ErrorBoundary 添加（main.tsx）
```typescript
// 修改前
ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>,
)

// 修改后
ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <ErrorBoundary>
      <App />
    </ErrorBoundary>
  </React.StrictMode>,
)
```

### ColdStartStagePage 调试与兜底
- 添加 console.log 调试日志
- 添加 roleId 验证与兜底
- 添加 try-catch 错误处理
- 添加红色边框调试样式
- 强制返回最小可用结构




